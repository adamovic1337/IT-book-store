$(window).on("load",function(){$(".sidenav").sidenav(),$(".modal").modal(),$(".dropdown-trigger").dropdown(),$("select").formSelect(),$(".materialboxed").materialbox(),pagination(),autocomplete(),searchFilter(),categoryFilter(),sort(),sendMail(),formAnimation(),signIn(),signUp(),addToCart(),insertShoppingItems(),removeAllShoppingItems()});function ajaxGET(a,b){$.ajax({url:a,dataType:"json",method:"get",success:b,error:function(a,b,c){M.toast({html:`${a.responseText}`}),console.log(a),console.log(b),console.log(c)}})}function ajaxPOST(a,b,c){$.ajax({url:a,dataType:"json",method:"post",async:!1,data:b,success:c,error:function(a,b,c){M.toast({html:`${a.responseJSON}`}),console.log(a),console.log(b),console.log(c)}})}function insertBooks(a){let b="";for(let c of a)b+=`<div class="col s3"><div class="row"><div class="col s12"><div class="card"><div class="card-image"><img src="public/img/small/${c.small}"></div><div class="card-action"><a href="index.php?page=details&book=${c.idBook}"class="btn waves-effect waves-light orange accent-4 button-center" target="_blank">Details</a></div></div></div></div></div>`;$("#books").html(b)}function autocomplete(){ajaxGET("index.php?ajax=autocomplete",function(a){let b={};for(let c of a){let a=c.name;b[a]=null}$("input.autocomplete").autocomplete({data:b})})}function pagination(){$(".pagination li a").on("click",function(a){a.preventDefault(),$(".pagination li").removeClass("active"),$(this).parent().addClass("active");let b=$(this).data("page");ajaxPOST("index.php",{ajax:"books",page:b},function(a){insertBooks(a)})})}function paginationLinks(a){let b="";for(let c=1;c<=a;c++)b+=1==c?`<li class="waves-effect active pagination"><a href="#" data-page="${c}">${c}</a></li>`:`<li class="waves-effect pagination"><a href="#" data-page="${c}">${c}</a></li>`;$("#pagination").html(b)}function paginationForFilter(a){$(".pagination li a").on("click",function(b){b.preventDefault(),$(".pagination li").removeClass("active"),$(this).parent().addClass("active"),a.page=$(this).data("page"),ajaxPOST("index.php",a,function(a){insertBooks(a)})})}function searchFilter(){$("#autocomplete-input").on("change",function(){$(".categories").prop("checked",!1),$(".sorting").prop("checked",!1);let a=$("#autocomplete-input").val().toLocaleLowerCase(),b={ajax:"search",searchString:a,page:1};ajaxPOST("index.php",b,function(c){insertBooks(c);ajaxPOST("index.php",{ajax:"paginationSearch",searchString:a},function(a){paginationLinks(a),paginationForFilter(b)})})})}function categoryFilter(){$(".categories").on("change",function(){$(".sorting").prop("checked",!1);let a=[];$(".categories:checked").each(function(){a.push($(this).val())});let b=a.join(",");let c={ajax:"filter",checked:b,page:1};""==b?(ajaxGET("index.php?ajax=filter",function(a){insertBooks(a)}),ajaxGET("index.php?ajax=paginationFilter",function(a){paginationLinks(a),pagination()})):ajaxPOST("index.php",c,function(a){insertBooks(a);let d={ajax:"paginationFilter",checked:b};ajaxPOST("index.php",d,function(a){paginationLinks(a),paginationForFilter(c)})})})}function sort(){$(".sorting").on("change",function(){$(".categories").prop("checked",!1);let a=$(this).val(),b={ajax:"sort",sortValue:a,page:1};ajaxPOST("index.php",b,function(c){insertBooks(c);ajaxPOST("index.php",{ajax:"paginationSort",sortValue:a},function(a){paginationLinks(a),paginationForFilter(b)})})})}function formAnimation(){$("#signup").hide(),$("#resetPass").hide(),$("#newacc").on("click",function(a){a.preventDefault(),$("#signin").fadeOut(function(){$("#signup").fadeIn()})}),$("#back1").on("click",function(a){a.preventDefault(),$("#signup").fadeOut(function(){$("#signin").fadeIn()})}),$("#forgotPass").on("click",function(a){a.preventDefault(),$("#signin").fadeOut(function(){$("#resetPass").fadeIn()})}),$("#back2").on("click",function(a){a.preventDefault(),$("#resetPass").fadeOut(function(){$("#signin").fadeIn()})})}function sendMail(){$("#sendMail").on("click",function(){let a=$("#sendMail").val(),b=$("#fullName").val(),c=$("#email").val(),d=$("#subject").val(),e=$("#message").val(),f={ajax:"mailer",sendMail:a},g=!0,h=/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/,i=/^[A-Z][a-z]{2,15}(\s[A-Z][a-z]{2,15})*$/;i.test(b)?(f.fullName=b,$("#fullName").removeClass("invalid"),$("#fullName").addClass("valid")):($("#fullName").addClass("invalid"),g=!1),h.test(c)?(f.email=c,$("#email").removeClass("invalid"),$("#email").addClass("valid")):($("#email").addClass("invalid"),g=!1),""==d?($("#subject").addClass("invalid"),g=!1):(f.subject=d,$("#subject").removeClass("invalid"),$("#subject").addClass("valid")),""==e?($("#message").addClass("invalid"),g=!1):(f.message=e,$("#message").removeClass("invalid"),$("#message").addClass("valid")),g&&($("#preloader").addClass("active"),$("#sendMail").hide(),ajaxPOST("index.php",f,function(a){M.toast({html:`${a}`}),$("#preloader").removeClass("active"),$("#sendMail").show()}))})}function signIn(){$("#siSend").on("click",function(){let a=$("#siUsername").val(),b=$("#siPassword").val(),c=$("#siSend").val(),d={ajax:"signIn",siSend:c},e=!0;""==a?($("#siUsername").addClass("invalid"),e=!1):(d.username=a,$("#siUsername").removeClass("invalid"),$("#siUsername").addClass("valid")),""==b?($("#siPassword").addClass("invalid"),e=!1):(d.password=b,$("#siPassword").removeClass("invalid"),$("#siPassword").addClass("valid")),e&&ajaxPOST("index.php",d,function(a){"OK"==a&&location.reload()})})}function signUp(){$("#suSend").on("click",function(){let a=$("#suUsername").val(),b=$("#suPassword").val(),c=$("#suEmail").val(),d=$("#suSend").val(),e=!0,f={ajax:"signUp",suSend:d},g=/(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.{8,})/,h=/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;13>=a.length&&3<=a.length?(f.username=a,$("#suUsername").removeClass("invalid"),$("#suUsername").addClass("valid")):($("#suUsername").addClass("invalid"),e=!1),g.test(b)?(f.password=b,$("#suPassword").removeClass("invalid"),$("#suPassword").addClass("valid")):($("#suPassword").addClass("invalid"),e=!1),h.test(c)?(f.email=c,$("#suEmail").removeClass("invalid"),$("#suEmail").addClass("valid")):($("#suEmail").addClass("invalid"),e=!1),e&&ajaxPOST("index.php",f,function(a){M.toast({html:`${a}`})})})}function updateProfile(){let a=$("#profileFirstName").val(),b=$("#profileLastName").val(),c=$("#profilePassword").val(),d=$("#profileEmail").val(),e=!0,f=/^[A-Z][a-z]{2,15}$/,g=/(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.{8,})/,h=/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;return f.test(a)||""==a?($("#profileFirstName").removeClass("invalid"),$("#profileFirstName").addClass("valid")):(e=!1,$("#profileFirstName").addClass("invalid")),f.test(b)||""==b?($("#profileLastName").removeClass("invalid"),$("#profileLastName").addClass("valid")):(e=!1,$("#profileLastName").addClass("invalid")),g.test(c)?($("#profilePassword").removeClass("invalid"),$("#profileLastName").addClass("valid")):(e=!1,$("#profilePassword").addClass("invalid")),h.test(d)?($("#profileEmail").removeClass("invalid"),$("#profileLastName").addClass("valid")):(e=!1,$("#profileEmail").addClass("invalid")),e}function addToCart(){$(".cart").on("click",function(){function a(){d.push(b),localStorage.setItem("cart",JSON.stringify(d)),M.toast({html:"Added to cart"})}let b=$(this).data("id"),c=inLocalStorage(b),d=getLocalStorage();c?M.toast({html:"Already in cart"}):null==d?(d=[],a()):a()})}function getLocalStorage(){return JSON.parse(localStorage.getItem("cart"))}function inLocalStorage(a){let b=getLocalStorage(),c=!1;if(null==b)c=!1;else for(let d of b)if(d==a){c=!0;break}return c}function removeFromLocalStorage(a){let b=inLocalStorage(a),c=getLocalStorage();if(b)if(1==c.length)localStorage.removeItem("cart"),location.reload();else{let b=c.filter(b=>b!=a);localStorage.setItem("cart",JSON.stringify(b))}}function insertShoppingItems(){let a=getLocalStorage(),b="";if(null!=a){b=a.join(",");let c={ajax:"cart",books:b};ajaxPOST("index.php",c,function(a){shoppingItems(a),removeShoppingItem(),payItems()})}}function shoppingItems(a){let b="",c=0;for(let d of a)c+=parseFloat(d.price),b+=`<tr><td>${d.isbn}</td><td>${d.name}</td><td class="price">$${d.price}</td><td><button type="button"  data-id="${d.idBook}"class="waves-effect waves-light btn-small btn-floating orange accent-4 dropBook"><i class="fas fa-times"></i></button></td></tr>`;b+=`<tr><td></td><td></td><td></td><td></td></tr><tr><td colspan="2">Total price:</td><td>$${c}</td><td><button type="submit" id="pay" value="pay"class="waves-effect waves-light btn-small orange accent-4">Pay</button></td></tr>`,$("#shopping").html(b)}function removeShoppingItem(){$(".dropBook").on("click",function(){let a=$(this).data("id");removeFromLocalStorage(a),insertShoppingItems()})}function removeAllShoppingItems(){$("#dropAllBooks").on("click",function(){localStorage.removeItem("cart"),location.reload()})}function payItems(){$("#pay").on("click",function(){let a=$(this).val(),b=$("#userShop").val(),c=[];$(".dropBook").each(function(){c.push($(this).data("id"))});ajaxPOST("index.php",{ajax:"pay",user:b,pay:a,ids:c},function(a){"ok"==a&&(M.toast({html:`Purchase successful`}),localStorage.removeItem("cart"),location.reload())})})}